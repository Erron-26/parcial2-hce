<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Historia Clínica - {{ paciente.documento_id }}</title>
    <style>
        /* CONFIGURACIÓN DE PÁGINA */
        @page {
            size: A4;
            margin: 2cm 1.5cm 3cm 1.5cm; /* Márgenes: Top, Right, Bottom, Left */
            
            /* PIE DE PÁGINA AUTOMÁTICO */
            @bottom-center {
                content: "Página " counter(page) " de " counter(pages);
                font-family: 'Helvetica', sans-serif;
                font-size: 9pt;
                color: #64748b;
            }
            @bottom-right {
                content: "Generado el: " string(date);
                font-family: 'Helvetica', sans-serif;
                font-size: 8pt;
                color: #94a3b8;
            }
        }

        /* ESTILOS GENERALES */
        body {
            font-family: 'Helvetica', 'Arial', sans-serif;
            font-size: 10pt;
            line-height: 1.4;
            color: #334155; /* Gris oscuro profesional */
        }

        h1, h2, h3, h4 { margin: 0; font-weight: bold; }

        /* ENCABEZADO DEL DOCUMENTO */
        .header {
            border-bottom: 3px solid #0e7490; /* Teal Corporativo */
            padding-bottom: 15px;
            margin-bottom: 25px;
            display: table; /* Truco para WeasyPrint layout */
            width: 100%;
        }
        .header-logo {
            display: table-cell;
            width: 60px;
            vertical-align: middle;
            font-size: 30pt;
            color: #0e7490;
        }
        .header-text {
            display: table-cell;
            vertical-align: middle;
            text-align: right;
        }
        .doc-title {
            font-size: 18pt;
            color: #0f172a;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .doc-subtitle {
            font-size: 10pt;
            color: #64748b;
        }

        /* SECCIÓN DATOS PACIENTE (TARJETA) */
        .patient-card {
            background-color: #f1f5f9; /* Fondo gris muy suave */
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 30px;
        }
        .patient-title {
            font-size: 11pt;
            color: #0e7490;
            text-transform: uppercase;
            border-bottom: 1px solid #cbd5e1;
            padding-bottom: 5px;
            margin-bottom: 10px;
            font-weight: bold;
        }
        
        /* Grid de datos usando tablas (WeasyPrint ama las tablas) */
        .info-table { width: 100%; border-collapse: collapse; }
        .info-table td { padding: 4px 0; vertical-align: top; }
        .label { font-weight: bold; color: #475569; font-size: 9pt; width: 110px; }
        .value { color: #0f172a; }

        /* HISTORIAL DE ATENCIONES */
        .section-title {
            font-size: 14pt;
            color: #0f172a;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 5px;
            margin-bottom: 20px;
            margin-top: 10px;
        }

        .attention-block {
            border: 1px solid #e2e8f0;
            border-left: 4px solid #0e7490; /* Borde izquierdo de color */
            padding: 15px;
            margin-bottom: 20px;
            page-break-inside: avoid; /* EVITA CORTAR LA ATENCIÓN A MITAD DE PÁGINA */
            background-color: #fff;
        }

        .att-header {
            background-color: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
            padding: 8px 10px;
            margin: -15px -15px 15px -15px; /* Expandir al borde */
            display: table;
            width: 100%;
        }
        .att-date { font-weight: bold; color: #0e7490; display: table-cell; }
        .att-type { text-align: right; color: #64748b; font-size: 9pt; display: table-cell; }

        .clinical-field { margin-bottom: 10px; }
        .field-label { 
            font-size: 8pt; 
            text-transform: uppercase; 
            color: #64748b; 
            font-weight: bold; 
            display: block;
            margin-bottom: 2px;
        }
        .field-content { display: block; text-align: justify; }

        .highlight-box {
            background-color: #f0fdf4; /* Verde muy claro */
            border: 1px solid #bbf7d0;
            padding: 8px;
            border-radius: 4px;
            margin-top: 5px;
        }

        /* FIRMA / DISCLAIMER */
        .footer-legal {
            margin-top: 50px;
            border-top: 1px solid #cbd5e1;
            padding-top: 10px;
            font-size: 7pt;
            color: #94a3b8;
            text-align: center;
        }
        
        /* Utilidades */
        .row { display: table; width: 100%; }
        .col-half { display: table-cell; width: 50%; vertical-align: top; }
    </style>
</head>
<body>
    
    <!-- CABECERA -->
    <div class="header">
        <div class="header-logo">✚</div> <!-- Puedes poner una imagen base64 aquí si quieres -->
        <div class="header-text">
            <div class="doc-title">Historia Clínica Unificada</div>
            <div class="doc-subtitle">Documento Confidencial • Generado por Sistema HCE Distribuido</div>
        </div>
    </div>

    <!-- FICHA DEL PACIENTE -->
    <div class="patient-card">
        <div class="patient-title">Información del Paciente</div>
        <div class="row">
            <div class="col-half">
                <table class="info-table">
                    <tr><td class="label">Nombre:</td><td class="value">{{ paciente.primer_nombre }} {{ paciente.primer_apellido }}</td></tr>
                    <tr><td class="label">Documento:</td><td class="value">{{ paciente.tipo_documento }} {{ paciente.documento_id }}</td></tr>
                    <tr><td class="label">Edad:</td><td class="value">{{ paciente.edad }} años ({{ paciente.fecha_nacimiento }})</td></tr>
                    <tr><td class="label">Sexo/Género:</td><td class="value">{{ paciente.sexo or 'N/A' }} / {{ paciente.genero or '' }}</td></tr>
                </table>
            </div>
            <div class="col-half">
                <table class="info-table">
                    <tr><td class="label">Grupo/RH:</td><td class="value">{{ paciente.grupo_sanguineo or '--' }} {{ paciente.factor_rh or '' }}</td></tr>
                    <tr><td class="label">Aseguradora:</td><td class="value">{{ paciente.entidad_afiliacion or 'Particular' }}</td></tr>
                    <tr><td class="label">Contacto:</td><td class="value">{{ paciente.celular or paciente.telefono or 'No registrado' }}</td></tr>
                    <tr><td class="label">Ubicación:</td><td class="value">{{ paciente.municipio_ciudad or '' }}</td></tr>
                </table>
            </div>
        </div>
    </div>

    <!-- CUERPO DE LA HISTORIA -->
    <div class="section-title">Evolución Clínica</div>

    {% if atenciones %}
        {% for atencion in atenciones %}
        <div class="attention-block">
            <div class="att-header">
                <div class="att-date">{{ atencion.fecha_hora_atencion.strftime('%Y-%m-%d %H:%M') }}</div>
                <div class="att-type">{{ atencion.tipo_atencion }} • Dr/a. {{ atencion.profesional_responsable_nombre or 'Staff' }}</div>
            </div>

            <!-- Motivo y Enfermedad -->
            <div class="clinical-field">
                <span class="field-label">Motivo de Consulta</span>
                <span class="field-content">{{ atencion.motivo_consulta }}</span>
            </div>

            {% if atencion.enfermedad_actual %}
            <div class="clinical-field">
                <span class="field-label">Enfermedad Actual / Anamnesis</span>
                <span class="field-content">{{ atencion.enfermedad_actual }}</span>
            </div>
            {% endif %}

            <!-- Datos Clínicos en columnas -->
            <div class="row" style="margin-top: 10px; margin-bottom: 10px;">
                <div class="col-half" style="padding-right: 10px;">
                    {% if atencion.antecedentes_personales %}
                    <div class="clinical-field">
                        <span class="field-label">Antecedentes</span>
                        <span class="field-content" style="font-size: 9pt;">{{ atencion.antecedentes_personales }}</span>
                    </div>
                    {% endif %}
                </div>
                <div class="col-half">
                    {% if atencion.examen_fisico_general %}
                    <div class="clinical-field">
                        <span class="field-label">Examen Físico</span>
                        <span class="field-content" style="font-size: 9pt;">{{ atencion.examen_fisico_general }}</span>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Diagnóstico y Plan (Resaltados) -->
            <div class="highlight-box">
                <div class="clinical-field">
                    <span class="field-label" style="color: #15803d;">Impresión Diagnóstica</span>
                    <span class="field-content" style="font-weight: bold;">{{ atencion.impresion_diagnostica }}</span>
                    {% if atencion.codigos_cie10 %}
                        <span style="font-size: 8pt; color: #64748b;">(CIE10: {{ atencion.codigos_cie10 | join(', ') }})</span>
                    {% endif %}
                </div>
                <div class="clinical-field" style="margin-bottom: 0;">
                    <span class="field-label" style="color: #15803d;">Plan de Manejo / Conducta</span>
                    <span class="field-content">{{ atencion.conducta_plan_manejo }}</span>
                </div>
            </div>

            {% if atencion.responsable_registro %}
            <div style="margin-top: 10px; font-size: 8pt; text-align: right; font-style: italic; color: #94a3b8;">
                Registrado por: {{ atencion.responsable_registro }}
            </div>
            {% endif %}
        </div>
        {% endfor %}
    {% else %}
        <div style="text-align: center; padding: 50px; color: #94a3b8; border: 2px dashed #e2e8f0;">
            No hay registros clínicos asociados a este paciente.
        </div>
    {% endif %}

    <!-- FOOTER LEGAL -->
    <div class="footer-legal">
        <p>Este documento contiene información confidencial amparada por el secreto médico profesional. Su uso es exclusivo para fines asistenciales.</p>
        <p>Generado electrónicamente. La validez de este documento está sujeta a la verificación en el sistema central.</p>
    </div>

</body>
</html>
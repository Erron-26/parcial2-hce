<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Historia Clínica - {{ paciente.documento_id }}</title>
    <style>
        @page {
            size: A4;
            margin: 2cm 1.5cm 2.5cm 1.5cm; /* Margen inferior para footer */

            @bottom-center {
                content: "Página " counter(page) " de " counter(pages);
                font-family: sans-serif; font-size: 8pt; color: #64748b;
            }
            @bottom-right {
                content: string(print-date);
                font-family: sans-serif; font-size: 7pt; color: #94a3b8;
            }
            @bottom-left {
                content: "HCE: {{ paciente.documento_id }}";
                font-family: sans-serif; font-size: 7pt; color: #cbd5e1;
            }
        }

        body {
            font-family: 'Helvetica', 'Arial', sans-serif;
            color: #334155;
            font-size: 9pt;
            line-height: 1.3;
        }

        /* Elemento oculto para pasar la fecha al footer CSS */
        #date-carrier { display: none; string-set: print-date content(); }

        /* --- HEADER --- */
        .header-table { width: 100%; border-bottom: 3px solid #0e7490; padding-bottom: 10px; margin-bottom: 20px; }
        .logo-cell { color: #0e7490; font-size: 20pt; font-weight: bold; vertical-align: middle; }
        .title-cell { text-align: right; vertical-align: middle; }
        .doc-h1 { font-size: 14pt; font-weight: bold; text-transform: uppercase; color: #0f172a; margin: 0; }
        .doc-sub { font-size: 9pt; color: #64748b; margin: 0; }

        /* --- DATOS PACIENTE (Vuelve la Grilla Organizada) --- */
        .pt-box { 
            background-color: #f8fafc; 
            border: 1px solid #cbd5e1; 
            border-radius: 6px; 
            padding: 12px; 
            margin-bottom: 25px; 
        }
        .pt-header {
            font-size: 10pt; font-weight: bold; color: #0e7490; 
            text-transform: uppercase; border-bottom: 1px solid #e2e8f0; 
            padding-bottom: 5px; margin-bottom: 8px;
        }
        .grid-table { width: 100%; border-collapse: collapse; }
        .grid-table td { padding: 3px; vertical-align: top; }
        .lbl { font-weight: bold; color: #64748b; font-size: 8pt; width: 85px; }
        .val { font-weight: bold; color: #0f172a; }

        /* --- BLOQUE DE ATENCIÓN --- */
        .att-wrapper { 
            border: 1px solid #cbd5e1; border-radius: 6px; 
            margin-bottom: 25px; page-break-inside: avoid; 
            background: #fff;
        }
        
        .att-head {
            background-color: #0e7490; color: white;
            padding: 8px 12px;
            border-radius: 5px 5px 0 0;
            display: table; width: 100%;
        }
        .att-date { font-weight: bold; font-size: 10pt; display: table-cell; }
        .att-type { text-align: right; font-size: 9pt; display: table-cell; font-weight: normal; }

        .att-body { padding: 15px; }

        /* --- SIGNOS VITALES (Gráfico) --- */
        .vitals-bar {
            display: table; width: 100%;
            background-color: #f1f5f9;
            border-radius: 4px;
            border: 1px solid #e2e8f0;
            margin-bottom: 15px;
            padding: 5px 0;
        }
        .v-item { display: table-cell; text-align: center; border-right: 1px solid #cbd5e1; width: 16%; }
        .v-item:last-child { border-right: none; }
        .v-lbl { font-size: 7pt; text-transform: uppercase; color: #64748b; display: block; }
        .v-val { font-size: 10pt; font-weight: bold; color: #0f172a; display: block; }

        /* --- TÍTULOS DE SECCIÓN --- */
        .sec-title {
            font-size: 9pt; font-weight: bold; text-transform: uppercase; 
            color: #0e7490; margin-top: 12px; margin-bottom: 4px; 
            border-bottom: 1px dotted #94a3b8;
        }

        .text-block { text-align: justify; margin-bottom: 8px; font-size: 9pt; }

        /* --- TABLA DE ANTECEDENTES (La que te gustaba) --- */
        .ant-table { width: 100%; border-collapse: collapse; margin-top: 5px; border: 1px solid #e2e8f0; }
        .ant-td { 
            width: 50%; padding: 6px; vertical-align: top; 
            border: 1px solid #e2e8f0; font-size: 8pt; 
        }
        .ant-head { display: block; font-weight: bold; color: #64748b; font-size: 7pt; margin-bottom: 2px; }
        .alert-cell { background-color: #fef2f2; }
        .alert-text { color: #b91c1c; font-weight: bold; }

        /* --- DIAGNÓSTICO --- */
        .dx-container {
            background-color: #f0fdf4; border: 1px solid #86efac; 
            padding: 10px; border-radius: 4px; margin-top: 15px;
        }

        /* --- FIRMA --- */
        .sig-block { margin-top: 35px; text-align: center; }
        .sig-line { border-top: 1px solid #64748b; width: 220px; margin: 0 auto 5px auto; }
        .sig-name { font-weight: bold; font-size: 9pt; color: #0f172a; }
        .sig-desc { font-size: 8pt; color: #64748b; font-style: italic; }

    </style>
</head>
<body>

    <!-- Fecha oculta para el CSS -->
    <div id="date-carrier">Generado: {{ fecha_impresion }}</div>

    <!-- HEADER -->
    <table class="header-table">
        <tr>
            <td class="logo-cell">SaludConnect</td>
            <td class="title-cell">
                <div class="doc-h1">Historia Clínica Unificada</div>
                <div class="doc-sub">Confidencial • Ley 23 de 1981</div>
            </td>
        </tr>
    </table>

    <!-- DATOS PACIENTE (Estilo Grilla Organizada) -->
    <div class="pt-box">
        <div class="pt-header">Información Demográfica</div>
        <table class="grid-table">
            <tr>
                <td class="lbl">PACIENTE:</td> <td class="val">{{ paciente.primer_nombre }} {{ paciente.segundo_nombre or '' }} {{ paciente.primer_apellido }} {{ paciente.segundo_apellido or '' }}</td>
                <td class="lbl">DOCUMENTO:</td> <td class="val">{{ paciente.tipo_documento }} {{ paciente.documento_id }}</td>
            </tr>
            <tr>
                <td class="lbl">EDAD:</td> <td class="val">{{ paciente.edad or '--' }} años ({{ paciente.fecha_nacimiento }})</td>
                <td class="lbl">GÉNERO:</td> <td class="val">{{ paciente.genero or '--' }}</td>
            </tr>
            <tr>
                <td class="lbl">RH:</td> <td class="val">{{ paciente.grupo_sanguineo or '' }} {{ paciente.factor_rh or '' }}</td>
                <td class="lbl">ESTADO CIVIL:</td> <td class="val">{{ paciente.estado_civil or '--' }}</td>
            </tr>
            <tr>
                <td class="lbl">DIRECCIÓN:</td> <td class="val" colspan="3">{{ paciente.direccion_residencia or '--' }} - {{ paciente.municipio_ciudad or '' }}</td>
            </tr>
            <tr>
                <td class="lbl">CONTACTO:</td> <td class="val">{{ paciente.celular or paciente.telefono or '--' }}</td>
                <td class="lbl">EMAIL:</td> <td class="val">{{ paciente.correo_electronico or '--' }}</td>
            </tr>
            <tr>
                <td class="lbl">ENTIDAD:</td> <td class="val">{{ paciente.entidad_afiliacion or 'PARTICULAR' }}</td>
                <td class="lbl">RÉGIMEN:</td> <td class="val">{{ paciente.regimen_afiliacion or '--' }}</td>
            </tr>
        </table>
    </div>

    <!-- HISTORIAL -->
    {% if atenciones %}
        {% for att in atenciones %}
        <div class="att-wrapper">
            <!-- Header sin redundancia -->
            <div class="att-head">
                <div class="att-date">{{ att.fecha_hora_atencion.strftime('%d-%m-%Y %H:%M') }}</div>
                <div class="att-type">{{ att.tipo_atencion }}</div>
            </div>

            <div class="att-body">
                
                <!-- SIGNOS VITALES (Limpio) -->
                {% if att.signos_vitales and att.signos_vitales|length > 0 %}
                <div class="vitals-bar">
                    {% if att.signos_vitales.ta %}<div class="v-item"><span class="v-lbl">P. Arterial</span><span class="v-val">{{ att.signos_vitales.ta }}</span></div>{% endif %}
                    {% if att.signos_vitales.fc %}<div class="v-item"><span class="v-lbl">F. Cardíaca</span><span class="v-val">{{ att.signos_vitales.fc }}</span></div>{% endif %}
                    {% if att.signos_vitales.fr %}<div class="v-item"><span class="v-lbl">F. Resp.</span><span class="v-val">{{ att.signos_vitales.fr }}</span></div>{% endif %}
                    {% if att.signos_vitales.temp %}<div class="v-item"><span class="v-lbl">Temp.</span><span class="v-val">{{ att.signos_vitales.temp }}°</span></div>{% endif %}
                    {% if att.signos_vitales.sat %}<div class="v-item"><span class="v-lbl">Sat O2</span><span class="v-val">{{ att.signos_vitales.sat }}%</span></div>{% endif %}
                    {% if att.signos_vitales.peso %}<div class="v-item"><span class="v-lbl">Peso</span><span class="v-val">{{ att.signos_vitales.peso }}kg</span></div>{% endif %}
                </div>
                {% endif %}

                <!-- MOTIVO Y ENFERMEDAD -->
                <div class="sec-title">Anamnesis</div>
                <div class="text-block">
                    <strong>Motivo:</strong> {{ att.motivo_consulta }}
                </div>
                {% if att.enfermedad_actual %}
                <div class="text-block">
                    <strong>Enfermedad Actual:</strong> {{ att.enfermedad_actual }}
                </div>
                {% endif %}

                <!-- ANTECEDENTES (Tabla 2x2 Organizada) -->
                {% if att.antecedentes_personales or att.antecedentes_familiares or att.medicamentos_actuales or att.alergias_conocidas %}
                <div class="sec-title">Antecedentes</div>
                <table class="ant-table">
                    <tr>
                        <td class="ant-td">
                            <span class="ant-head">PERSONALES / PATOLÓGICOS</span>
                            {{ att.antecedentes_personales or 'Niega' }}
                        </td>
                        <td class="ant-td alert-cell">
                            <span class="ant-head" style="color:#b91c1c;">ALERGIAS</span>
                            <span class="alert-text">{{ att.alergias_conocidas or 'Niega' }}</span>
                        </td>
                    </tr>
                    <tr>
                        <td class="ant-td">
                            <span class="ant-head">FAMILIARES</span>
                            {{ att.antecedentes_familiares or 'No refiere' }}
                        </td>
                        <td class="ant-td">
                            <span class="ant-head">FARMCOLÓGICOS / ACTUALES</span>
                            {{ att.medicamentos_actuales or 'No refiere' }}
                        </td>
                    </tr>
                </table>
                {% endif %}

                <!-- EXAMEN FÍSICO -->
                {% if att.examen_fisico_general or att.examen_fisico_por_sistemas %}
                <div class="sec-title">Examen Físico</div>
                <table class="grid-table">
                    <tr>
                        {% if att.examen_fisico_general %}
                        <td width="50%" style="padding-right:10px;">
                            <strong>General:</strong><br>{{ att.examen_fisico_general }}
                        </td>
                        {% endif %}
                        {% if att.examen_fisico_por_sistemas %}
                        <td width="50%">
                            <strong>Por Sistemas:</strong><br>{{ att.examen_fisico_por_sistemas }}
                        </td>
                        {% endif %}
                    </tr>
                </table>
                {% endif %}

                <!-- DX Y PLAN -->
                <div class="dx-container">
                    <div style="color:#166534; font-weight:bold; font-size:8pt; text-transform:uppercase;">Impresión Diagnóstica</div>
                    <div style="margin-bottom:5px;">{{ att.impresion_diagnostica }}</div>
                    
                    {% if att.codigos_cie10 %}
                    <div style="font-size:8pt; color:#64748b; margin-bottom:8px;">
                        <strong>CIE10:</strong> {{ att.codigos_cie10 | join(', ') }}
                    </div>
                    {% endif %}
                    
                    <div style="border-top:1px dashed #86efac; margin-top:8px; padding-top:8px;">
                        <div style="color:#166534; font-weight:bold; font-size:8pt; text-transform:uppercase;">Conducta / Plan</div>
                        <div>{{ att.conducta_plan_manejo }}</div>
                    </div>
                </div>

                <!-- FIRMA -->
                <div class="sig-block">
                    <div class="sig-line"></div>
                    <div class="sig-name">Dr/a. {{ att.profesional_nombre_temp }}</div>
                    <div class="sig-desc">Registro Médico Habilitado</div>
                </div>

            </div>
        </div>
        {% endfor %}
    {% else %}
        <div style="text-align:center; padding:50px; color:#94a3b8;">No existen registros de atención.</div>
    {% endif %}

</body>
</html>
{% extends "base.html" %}

{% block title %}Portal Médico{% endblock %}

{% block content %}
<div class="row mb-4 align-items-center">
    <div class="col">
        <h2 class="fw-bold text-dark mb-0">Portal Médico</h2>
        <p class="text-muted">Consulta y registro clínico</p>
    </div>
    <div class="col-auto">
        <a href="/dashboard" class="btn btn-light text-muted border"><i class="bi bi-arrow-left me-1"></i> Dashboard</a>
    </div>
</div>

<!-- Buscador Flotante -->
<div class="card mb-5 border-0 shadow-sm">
  <div class="card-body p-4">
    <form id="search-form" class="row g-3 align-items-end">
        <div class="col-md-10">
            <label for="search-doc-id" class="form-label fw-bold text-primary-custom small text-uppercase">Buscar Paciente</label>
            <div class="input-group input-group-lg">
                <span class="input-group-text bg-white border-end-0 text-muted"><i class="bi bi-search"></i></span>
                <input type="number" class="form-control border-start-0 ps-0" id="search-doc-id" placeholder="Ingrese número de documento" required>
            </div>
        </div>
        <div class="col-md-2 d-grid">
            <button class="btn btn-primary btn-lg" type="submit">Buscar</button>
        </div>
    </form>
  </div>
</div>

<div id="results-container"></div>

<script>
  function formatError(err) {
    if (typeof err.detail === 'string') return err.detail;
    return JSON.stringify(err);
  }

  // Función auxiliar segura para textos
  const safeText = (text) => {
      if (text === null || text === undefined || text === "") return '<span class="text-muted fst-italic">No registrado</span>';
      return text;
  };

  document.getElementById("search-form").addEventListener("submit", async function(e) {
    e.preventDefault();
    const docId = document.getElementById("search-doc-id").value;
    const container = document.getElementById("results-container");
    
    container.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-primary" role="status"></div><p class="mt-2 text-muted">Buscando en base distribuida...</p></div>';

    try {
      const res = await fetch(`/api/pacientes/${docId}`);
      if (!res.ok) throw await res.json();
      const paciente = await res.json();
      renderPatient(paciente);
    } catch (err) {
      container.innerHTML = `<div class="alert alert-warning border-0 shadow-sm"><i class="bi bi-exclamation-triangle-fill me-2"></i> ${formatError(err)}</div>`;
    }
  });

  function renderPatient(p) {
    console.log("Datos completos del paciente:", p); // Log para depurar
    const container = document.getElementById("results-container");

    // Renderizado del Historial
    let historyHTML = '<div class="text-center p-4 bg-light rounded-3 text-muted">No hay historial previo.</div>';
    
    if (p.atenciones && p.atenciones.length > 0) {
        historyHTML = '<div class="accordion custom-accordion" id="historyAcc">';
        p.atenciones.forEach((a, i) => {
            console.log(`Datos de la atención #${i}:`, a); // Log para cada atención
            const motivo = safeText(a.motivo_consulta);
            const enfermedad = safeText(a.enfermedad_actual);
            const plan = safeText(a.conducta_plan_manejo);
            const diag = safeText(a.impresion_diagnostica);
            
            historyHTML += `
            <div class="accordion-item border-0 mb-3 shadow-sm rounded overflow-hidden">
                <h2 class="accordion-header" id="h-${i}">
                    <button class="accordion-button collapsed bg-white" type="button" data-bs-toggle="collapse" data-bs-target="#c-${i}">
                        <div class="d-flex flex-column flex-md-row w-100 gap-2 align-items-md-center">
                            <span class="badge bg-primary bg-opacity-10 text-primary-custom rounded-pill me-2">${a.tipo_atencion || 'Consulta'}</span>
                            <span class="fw-bold text-dark flex-grow-1">${new Date(a.fecha_hora_atencion).toLocaleString()}</span>
                            <small class="text-muted me-3"><i class="bi bi-person-badge me-1"></i>${a.profesional_responsable_nombre || 'Médico'}</small>
                        </div>
                    </button>
                </h2>
                <div id="c-${i}" class="accordion-collapse collapse" data-bs-parent="#historyAcc">
                    <div class="accordion-body bg-light bg-opacity-25">
                        <div class="row g-4">
                            <div class="col-md-6">
                                <label class="small text-uppercase text-muted fw-bold">Motivo</label>
                                <p class="mb-0">${motivo}</p>
                            </div>
                            <div class="col-md-6">
                                <label class="small text-uppercase text-muted fw-bold">Diagnóstico</label>
                                <p class="mb-0">${diag}</p>
                            </div>
                            <div class="col-12">
                                <div class="p-3 bg-white rounded border border-light">
                                    <label class="small text-uppercase text-primary-custom fw-bold mb-2">Enfermedad Actual</label>
                                    <p class="mb-0 text-secondary">${enfermedad}</p>
                                </div>
                            </div>
                            <div class="col-12">
                                <div class="p-3 bg-white rounded border border-light">
                                    <label class="small text-uppercase text-success fw-bold mb-2">Plan de Manejo</label>
                                    <p class="mb-0 text-secondary">${plan}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>`;
        });
        historyHTML += '</div>';
    }

    // Renderizado Principal
    container.innerHTML = `
      <div class="row g-4">
        <!-- Sidebar Datos Paciente -->
        <div class="col-lg-4">
            <div class="card border-0 shadow-sm h-100 sticky-top" style="top: 5rem; z-index: 1;">
                <div class="card-body text-center p-4">
                    <div class="mb-3 position-relative d-inline-block">
                        <div class="rounded-circle bg-gray-200 d-flex align-items-center justify-content-center bg-light text-secondary" style="width: 100px; height: 100px; margin: 0 auto;">
                            <i class="bi bi-person-fill display-4"></i>
                        </div>
                        <span class="position-absolute bottom-0 end-0 badge rounded-pill bg-success border border-white">Activo</span>
                    </div>
                    <h3 class="fw-bold">${p.primer_nombre} ${p.primer_apellido}</h3>
                    <p class="text-muted mb-4">${p.tipo_documento} ${p.documento_id}</p>
                    
                    <div class="d-grid gap-2 mb-4">
                        <a href="/exportar_pdf/${p.documento_id}" target="_blank" class="btn btn-outline-danger">
                            <i class="bi bi-file-pdf me-2"></i> Exportar PDF
                        </a>
                    </div>

                    <ul class="list-group list-group-flush text-start small">
                        <li class="list-group-item px-0 bg-transparent d-flex justify-content-between">
                            <span class="text-muted">Edad</span> <span>${p.edad || '--'} años</span>
                        </li>
                        <li class="list-group-item px-0 bg-transparent d-flex justify-content-between">
                            <span class="text-muted">Género</span> <span>${p.genero || '--'}</span>
                        </li>
                        <li class="list-group-item px-0 bg-transparent d-flex justify-content-between">
                            <span class="text-muted">Sangre</span> <span class="badge bg-danger bg-opacity-10 text-danger">${p.grupo_sanguineo || '?'} ${p.factor_rh || ''}</span>
                        </li>
                        <li class="list-group-item px-0 bg-transparent">
                            <span class="text-muted d-block mb-1">Contacto</span>
                            <i class="bi bi-envelope me-1"></i> ${p.correo_electronico}
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Columna Central: Historial y Nueva Atención -->
        <div class="col-lg-8">
            <!-- Botón Nueva Atención (Collapse) -->
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4 class="fw-bold m-0">Historial Clínico</h4>
                <button class="btn btn-primary rounded-pill px-4" type="button" data-bs-toggle="collapse" data-bs-target="#formCollapse">
                    <i class="bi bi-plus-lg me-2"></i> Nueva Atención
                </button>
            </div>

            <!-- Formulario Nueva Atención -->
            <div class="collapse mb-4" id="formCollapse">
                <div class="card border-0 shadow border-top border-primary border-4">
                    <div class="card-body p-4">
                        <h5 class="fw-bold mb-4 text-primary-custom">Registrar Evolución</h5>
                        <div id="form-alert"></div>
                        <form id="new-attention-form" class="row g-3">
                            <input type="hidden" name="documento_id" value="${p.documento_id}">
                            
                            <div class="col-md-6">
                                <label class="form-label small fw-bold text-muted">Tipo</label>
                                <select class="form-select" name="tipo_atencion">
                                    <option>Consulta Externa</option>
                                    <option>Urgencias</option>
                                    <option>Control</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label small fw-bold text-muted">CIE10 (Sep. comas)</label>
                                <input type="text" class="form-control" name="codigos_cie10" placeholder="E11.9, I10">
                            </div>

                            <div class="col-12">
                                <label class="form-label small fw-bold text-muted">Motivo de Consulta *</label>
                                <textarea class="form-control" name="motivo_consulta" rows="2" required></textarea>
                            </div>
                            <div class="col-12">
                                <label class="form-label small fw-bold text-muted">Enfermedad Actual *</label>
                                <textarea class="form-control" name="enfermedad_actual" rows="3" required></textarea>
                            </div>

                            <!-- Pestañas internas para organizar mejor el form -->
                            <div class="col-12">
                                <ul class="nav nav-tabs mt-2" id="medTabs" role="tablist">
                                    <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#tab-exam">Examen Físico</a></li>
                                    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tab-ant">Antecedentes</a></li>
                                    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tab-plan">Plan & Dx</a></li>
                                </ul>
                                <div class="tab-content p-3 border border-top-0 bg-light rounded-bottom">
                                    <!-- Tab Examen -->
                                    <!-- Tab Examen Físico Mejorado -->
                            <div class="tab-pane fade show active" id="tab-exam"> 
                                <label class="form-label small fw-bold text-primary-custom mb-2">Signos Vitales</label>
                                <div class="card bg-light border-0 p-3 mb-3">
                                    <div class="row g-3">
                                        <div class="col-6 col-md-4 col-lg-2">
                                            <label class="small text-muted fw-bold">T. Arterial</label>
                                            <div class="input-group input-group-sm">
                                                <input type="text" class="form-control" id="sv_ta" placeholder="120/80">
                                                <span class="input-group-text text-muted">mmHg</span>
                                            </div>
                                        </div>
                                        <div class="col-6 col-md-4 col-lg-2">
                                            <label class="small text-muted fw-bold">F. Cardíaca</label>
                                            <div class="input-group input-group-sm">
                                                <input type="number" class="form-control" id="sv_fc" placeholder="80">
                                                <span class="input-group-text text-muted">bpm</span>
                                            </div>
                                        </div>
                                        <div class="col-6 col-md-4 col-lg-2">
                                            <label class="small text-muted fw-bold">F. Resp.</label>
                                            <div class="input-group input-group-sm">
                                                <input type="number" class="form-control" id="sv_fr" placeholder="16">
                                                <span class="input-group-text text-muted">rpm</span>
                                            </div>
                                        </div>
                                        <div class="col-6 col-md-4 col-lg-2">
                                            <label class="small text-muted fw-bold">Temp.</label>
                                            <div class="input-group input-group-sm">
                                                <input type="number" step="0.1" class="form-control" id="sv_temp" placeholder="36.5">
                                                <span class="input-group-text text-muted">°C</span>
                                            </div>
                                        </div>
                                        <div class="col-6 col-md-4 col-lg-2">
                                            <label class="small text-muted fw-bold">Saturación</label>
                                            <div class="input-group input-group-sm">
                                                <input type="number" class="form-control" id="sv_sat" placeholder="98">
                                                <span class="input-group-text text-muted">%</span>
                                            </div>
                                        </div>
                                        <div class="col-6 col-md-4 col-lg-2">
                                            <label class="small text-muted fw-bold">Peso</label>
                                            <div class="input-group input-group-sm">
                                                <input type="number" step="0.1" class="form-control" id="sv_peso" placeholder="70">
                                                <span class="input-group-text text-muted">kg</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label class="form-label small fw-bold text-muted">Examen Físico General</label>
                                        <textarea class="form-control" name="examen_fisico_general" rows="3" placeholder="Paciente consciente, orientado, hidratado..."></textarea>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label small fw-bold text-muted">Examen por Sistemas</label>
                                        <textarea class="form-control" name="examen_fisico_por_sistemas" rows="3" placeholder="Cardiopulmonar: Ruidos rítmicos..."></textarea>
                                    </div>
                                </div>
                            </div>
                                    <!-- Tab Antecedentes -->
                                    <div class="tab-pane fade" id="tab-ant">
                                        <div class="row g-3">
                                            <div class="col-md-6">
                                                <label class="form-label small fw-bold text-muted">Patológicos / Personales</label>
                                                <textarea class="form-control" name="antecedentes_personales" rows="2" placeholder="HTA, Diabetes, Cirugías..."></textarea>
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label small fw-bold text-muted">Familiares</label>
                                                <!-- ¡AQUÍ ESTÁ EL CAMPO FALTANTE! -->
                                                <textarea class="form-control" name="antecedentes_familiares" rows="2" placeholder="Padre, Madre, Hereditarios..."></textarea>
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label small fw-bold text-muted">Farmacológicos / Actuales</label>
                                                <textarea class="form-control" name="medicamentos_actuales" rows="2" placeholder="Medicamentos en uso..."></textarea>
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label small fw-bold text-danger">Alergias</label>
                                                <textarea class="form-control border-danger bg-danger bg-opacity-10" name="alergias_conocidas" rows="2" placeholder="Medicamentos, Alimentos..."></textarea>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Tab Plan -->
                                    <div class="tab-pane fade" id="tab-plan">
                                        <label class="form-label small fw-bold">Impresión Diagnóstica *</label>
                                        <textarea class="form-control mb-3" name="impresion_diagnostica" rows="2" required></textarea>
                                        
                                        <label class="form-label small fw-bold">Plan de Manejo *</label>
                                        <textarea class="form-control" name="conducta_plan_manejo" rows="3" required></textarea>
                                    </div>
                                </div>
                            </div>

                            <div class="col-12 text-end mt-3">
                                <button type="button" class="btn btn-link text-muted text-decoration-none me-2" data-bs-toggle="collapse" data-bs-target="#formCollapse">Cancelar</button>
                                <button type="submit" class="btn btn-success px-4">Guardar Evolución</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Lista Historial -->
            ${historyHTML}
        </div>
      </div>
    `;
    
    // Re-attach listener al form
    const form = document.getElementById('new-attention-form');
    if(form) form.addEventListener('submit', handleSave);
  }

async function handleSave(e) {
    e.preventDefault();
    const formData = new FormData(e.target);
    const data = Object.fromEntries(formData.entries());
    
    // --- NUEVA LÓGICA DE SIGNOS VITALES ---
    // Recolectamos los inputs individuales
    const signosVitalesObj = {
        ta: document.getElementById('sv_ta').value,
        fc: document.getElementById('sv_fc').value,
        fr: document.getElementById('sv_fr').value,
        temp: document.getElementById('sv_temp').value,
        sat: document.getElementById('sv_sat').value,
        peso: document.getElementById('sv_peso').value
    };

    // Filtramos los vacíos (para no guardar claves con valor "")
    const signosVitalesLimpio = {};
    let haySignos = false;
    Object.keys(signosVitalesObj).forEach(key => {
        if (signosVitalesObj[key]) {
            signosVitalesLimpio[key] = signosVitalesObj[key];
            haySignos = true;
        }
    });

    // Si el médico escribió al menos un signo vital, lo agregamos al objeto data
    if (haySignos) {
        data.signos_vitales = signosVitalesLimpio; // El backend lo recibirá ya como objeto JSON (FastAPI + Pydantic lo manejan)
    } else {
        data.signos_vitales = null;
    }
    // ---------------------------------------

    // Limpieza básica de datos vacíos del resto del form
    Object.keys(data).forEach(k => !data[k] && delete data[k]);

    if (data.codigos_cie10) {
        data.codigos_cie10 = data.codigos_cie10.split(',').map(x=>x.trim());
    }

    const btn = e.target.querySelector('button[type="submit"]');
    const alertBox = document.getElementById('form-alert');
    
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Guardando...';
    alertBox.innerHTML = '';

    try {
        const res = await fetch('/api/atenciones/', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });
        if (!res.ok) throw await res.json();
        
        alertBox.innerHTML = '<div class="alert alert-success shadow-sm"><i class="bi bi-check-circle me-2"></i>Evolución registrada correctamente.</div>';
        
        // Limpiar formulario manual para los campos no controlados por form.reset()
        document.getElementById('sv_ta').value = '';
        document.getElementById('sv_fc').value = '';
        document.getElementById('sv_fr').value = '';
        document.getElementById('sv_temp').value = '';
        document.getElementById('sv_sat').value = '';
        document.getElementById('sv_peso').value = '';
        e.target.reset();

        setTimeout(() => {
            document.getElementById('search-form').requestSubmit(); // Recargar datos del paciente
            // Cerrar collapse
            const collapseElement = document.getElementById('formCollapse');
            const bsCollapse = bootstrap.Collapse.getInstance(collapseElement);
            if(bsCollapse) bsCollapse.hide();
            
            btn.disabled = false;
            btn.innerHTML = 'Guardar Evolución';
            alertBox.innerHTML = '';
        }, 1500);
    } catch (err) {
        alertBox.innerHTML = `<div class="alert alert-danger shadow-sm"><i class="bi bi-exclamation-triangle me-2"></i>${formatError(err)}</div>`;
        btn.disabled = false;
        btn.innerHTML = 'Guardar Evolución';
    }
}
</script>

<style>
    /* Ajuste específico para el acordeón limpio */
    .custom-accordion .accordion-button:not(.collapsed) {
        background-color: rgba(14, 116, 144, 0.05); /* Primary muy suave */
        color: var(--primary-color);
        box-shadow: none;
    }
    .custom-accordion .accordion-button:focus {
        box-shadow: none;
        border-color: rgba(0,0,0,0.1);
    }
</style>
{% endblock %}

{% extends "base.html" %}

{% block title %}Portal Admisionista{% endblock %}

{% block content %}
<div class="row mb-4 align-items-center">
    <div class="col">
        <h2 class="fw-bold text-dark mb-0">Gestión de Admisiones</h2>
        <p class="text-muted">Registro y actualización de base de datos de pacientes</p>
    </div>
    <div class="col-auto">
        <a href="/dashboard" class="btn btn-light text-muted border"><i class="bi bi-arrow-left me-1"></i> Dashboard</a>
    </div>
</div>

<div class="card border-0 shadow-sm overflow-hidden">
    <div class="card-header bg-white border-bottom p-0">
        <ul class="nav nav-tabs nav-justified" id="admision-tabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active py-3 fw-bold rounded-0 border-0 border-bottom border-3 border-primary" id="search-tab" data-bs-toggle="tab" data-bs-target="#search-panel" type="button">
                    <i class="bi bi-search me-2"></i>Búsqueda y Edición
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link py-3 fw-bold rounded-0 border-0 text-muted" id="register-tab" data-bs-toggle="tab" data-bs-target="#register-panel" type="button" onclick="this.classList.add('border-bottom', 'border-3', 'border-success', 'text-success'); document.getElementById('search-tab').classList.remove('border-primary', 'active');">
                    <i class="bi bi-person-plus-fill me-2"></i>Nuevo Paciente
                </button>
            </li>
        </ul>
    </div>
    
    <div class="card-body p-4 p-lg-5 bg-light bg-opacity-25">
        <div class="tab-content" id="admision-tabs-content">
            
            <!-- PANEL 1: BÚSQUEDA -->
            <div class="tab-pane fade show active" id="search-panel" role="tabpanel">
                <div class="row justify-content-center">
                    <div class="col-lg-8">
                        <div class="text-center mb-4">
                            <h4 class="fw-bold text-primary-custom">Buscar Paciente Existente</h4>
                            <p class="text-muted">Ingresa el documento para actualizar datos de contacto o afiliación.</p>
                        </div>
                        
                        <form id="search-form" class="card card-body border-0 shadow-sm p-4 mb-5">
                            <div class="input-group input-group-lg">
                                <span class="input-group-text bg-white border-end-0 text-primary-custom"><i class="bi bi-person-vcard"></i></span>
                                <input type="number" class="form-control border-start-0 ps-0" id="search-doc-id" placeholder="Número de documento" required>
                                <button class="btn btn-primary px-4" type="submit">Buscar</button>
                            </div>
                        </form>

                        <div id="results-container"></div>
                    </div>
                </div>
            </div>

            <!-- PANEL 2: REGISTRO -->
            <div class="tab-pane fade" id="register-panel" role="tabpanel">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h4 class="fw-bold text-success mb-0">Registrar Nuevo Ingreso</h4>
                    <span class="badge bg-success bg-opacity-10 text-success border border-success">Formulario Oficial</span>
                </div>

                <div id="alert-container"></div>

                <form id="new-patient-form" class="row g-4 bg-white p-4 rounded-3 shadow-sm border border-light">
                    
                    <!-- Sección 1: Identidad -->
                    <div class="col-12">
                        <h6 class="text-uppercase text-muted fw-bold border-bottom pb-2 mb-3"><i class="bi bi-person-badge me-2"></i>Identificación y Datos Básicos</h6>
                    </div>
                    
                    <div class="col-md-3">
                        <label class="form-label small fw-bold text-muted">Tipo Doc.</label>
                        <select name="tipo_documento" class="form-select">
                            <option value="CC" selected>Cédula (CC)</option>
                            <option value="TI">Tarjeta Identidad</option>
                            <option value="RC">Registro Civil</option>
                            <option value="CE">Cédula Extranjería</option>
                        </select>
                    </div>
                    <div class="col-md-5">
                        <label class="form-label small fw-bold text-muted">Número de Documento *</label>
                        <input type="number" class="form-control fw-bold" name="documento_id" required>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label small fw-bold text-muted">Fecha Nacimiento</label>
                        <input type="date" class="form-control" name="fecha_nacimiento">
                    </div>

                    <div class="col-md-6">
                        <label class="form-label small fw-bold text-muted">Nombres *</label>
                        <div class="input-group">
                            <input type="text" class="form-control" name="primer_nombre" placeholder="Primer" required>
                            <input type="text" class="form-control" name="segundo_nombre" placeholder="Segundo">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label small fw-bold text-muted">Apellidos *</label>
                        <div class="input-group">
                            <input type="text" class="form-control" name="primer_apellido" placeholder="Primer" required>
                            <input type="text" class="form-control" name="segundo_apellido" placeholder="Segundo">
                        </div>
                    </div>

                    <div class="col-md-2">
                        <label class="form-label small fw-bold text-muted">Sexo</label>
                        <select name="sexo" class="form-select">
                            <option value="Masculino">Masculino</option>
                            <option value="Femenino">Femenino</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label small fw-bold text-muted">Género</label>
                        <input type="text" class="form-control" name="genero" placeholder="Opcional">
                    </div>
                    
                    <div class="col-md-3">
                        <label class="form-label small fw-bold text-muted">Estado Civil</label>
                        <select name="estado_civil" class="form-select">
                            <option value="Soltero" selected>Soltero/a</option>
                            <option value="Casado">Casado/a</option>
                            <option value="Union Libre">Unión Libre</option>
                            <option value="Divorciado">Divorciado/a</option>
                            <option value="Viudo">Viudo/a</option>
                        </select>
                    </div>

                    <div class="col-md-2">
                        <label class="form-label small fw-bold text-muted">G. Sanguíneo</label>
                        <select name="grupo_sanguineo" class="form-select">
                            <option value="" selected disabled>--</option>
                            <option value="O">O</option>
                            <option value="A">A</option>
                            <option value="B">B</option>
                            <option value="AB">AB</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label small fw-bold text-muted">RH</label>
                        <select name="factor_rh" class="form-select">
                            <option value="+" selected>+</option>
                            <option value="-">-</option>
                        </select>
                    </div>

                    <!-- Sección 2: Contacto -->
                    <div class="col-12 mt-4">
                        <h6 class="text-uppercase text-muted fw-bold border-bottom pb-2 mb-3"><i class="bi bi-geo-alt me-2"></i>Ubicación y Contacto</h6>
                    </div>

                    <div class="col-md-6">
                        <label class="form-label small fw-bold text-muted">Correo Electrónico *</label>
                        <input type="email" class="form-control" name="correo_electronico" required>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label small fw-bold text-muted">Contraseña Provisional *</label>
                        <input type="password" class="form-control bg-light" name="password" required>
                    </div>
                    
                    <div class="col-md-4">
                        <label class="form-label small fw-bold text-muted">Celular</label>
                        <input type="tel" class="form-control" name="celular">
                    </div>
                    <div class="col-md-8">
                        <label class="form-label small fw-bold text-muted">Dirección Residencia</label>
                        <input type="text" class="form-control" name="direccion_residencia">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label small fw-bold text-muted">Ciudad / Municipio</label>
                        <input type="text" class="form-control" name="municipio_ciudad">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label small fw-bold text-muted">Departamento</label>
                        <input type="text" class="form-control" name="departamento">
                    </div>

                    <!-- Sección 3: Afiliación -->
                    <div class="col-12 mt-4">
                        <h6 class="text-uppercase text-muted fw-bold border-bottom pb-2 mb-3"><i class="bi bi-hospital me-2"></i>Seguridad Social</h6>
                    </div>

                    <div class="col-md-6">
                        <label class="form-label small fw-bold text-muted">EPS / Entidad</label>
                        <input type="text" class="form-control" name="entidad_afiliacion">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label small fw-bold text-muted">Régimen</label>
                        <select name="regimen_afiliacion" class="form-select">
                            <option value="Contributivo">Contributivo</option>
                            <option value="Subsidiado">Subsidiado</option>
                            <option value="Especial">Especial</option>
                        </select>
                    </div>

                    <div class="col-12 mt-4 pt-3 text-end border-top">
                        <button type="reset" class="btn btn-light me-2">Limpiar</button>
                        <button type="submit" class="btn btn-success btn-lg px-5 shadow-sm">
                            <i class="bi bi-save me-2"></i>Registrar Paciente
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
  function formatError(err) {
    if (typeof err.detail === 'string') return err.detail;
    return JSON.stringify(err);
  }

  // Registro
  document.getElementById("new-patient-form").addEventListener("submit", async function(e) {
    e.preventDefault();
    const form = e.target;
    const data = Object.fromEntries(new FormData(form).entries());
    data['tipo_usuario'] = 'paciente';

    // Limpieza de campos vacíos
    Object.keys(data).forEach(k => !data[k] && delete data[k]);

    const alertBox = document.getElementById("alert-container");
    const btn = form.querySelector('button[type="submit"]');
    
    alertBox.innerHTML = '';
    btn.disabled = true;
    btn.innerHTML = 'Guardando...';

    try {
      const res = await fetch("/api/pacientes/", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data),
        credentials: 'same-origin'
      });
      if (!res.ok) throw await res.json();
      
      alertBox.innerHTML = '<div class="alert alert-success shadow-sm"><i class="bi bi-check-circle-fill me-2"></i>Paciente registrado correctamente.</div>';
      form.reset();
    } catch (err) {
      alertBox.innerHTML = `<div class="alert alert-danger shadow-sm"><i class="bi bi-exclamation-octagon-fill me-2"></i> ${formatError(err)}</div>`;
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-save me-2"></i>Registrar Paciente';
    }
  });

  // Búsqueda
  document.getElementById("search-form").addEventListener("submit", async function(e) {
    e.preventDefault();
    const docId = document.getElementById("search-doc-id").value;
    const container = document.getElementById("results-container");
    
    container.innerHTML = '<div class="text-center py-4"><div class="spinner-border text-primary"></div></div>';

    try {
      // NOTA: Si tu backend no tiene ruta específica para admisionistas,
      // asegúrate de que el rol tenga permiso en /api/pacientes/{id}
      const res = await fetch(`/api/admision/pacientes/${docId}`, {credentials: 'same-origin'});
      if (!res.ok) throw await res.json();
      const p = await res.json();
      renderUpdateForm(p);
    } catch (err) {
      container.innerHTML = `<div class="alert alert-warning mt-4 text-center">No se encontró el paciente o no tienes permisos.</div>`;
    }
  });

  function renderUpdateForm(p) {
    const container = document.getElementById("results-container");
    const dob = p.fecha_nacimiento ? p.fecha_nacimiento.split('T')[0] : '';

    container.innerHTML = `
      <div class="card border-0 shadow-sm mt-4 animate-fade-in">
        <div class="card-header bg-primary bg-opacity-10 text-primary-custom fw-bold">
            <i class="bi bi-pencil-square me-2"></i>Editar Información del Paciente
        </div>
        <div class="card-body p-4">
            <div id="update-alert"></div>
            <form id="update-form" class="row g-3">
                <input type="hidden" name="documento_id" value="${p.documento_id}">
                
                <div class="col-md-6">
                    <label class="small fw-bold text-muted">Nombre Completo</label>
                    <input class="form-control bg-light" value="${p.primer_nombre} ${p.primer_apellido}" disabled readonly>
                </div>
                <div class="col-md-6">
                    <label class="small fw-bold text-muted">Documento</label>
                    <input class="form-control bg-light" value="${p.tipo_documento} ${p.documento_id}" disabled readonly>
                </div>

                <div class="col-md-6">
                    <label class="small fw-bold text-muted">Correo</label>
                    <input type="email" class="form-control" name="correo_electronico" value="${p.correo_electronico || ''}">
                </div>
                <div class="col-md-6">
                    <label class="small fw-bold text-muted">Celular</label>
                    <input type="tel" class="form-control" name="celular" value="${p.celular || ''}">
                </div>
                <div class="col-12">
                    <label class="small fw-bold text-muted">Dirección</label>
                    <input type="text" class="form-control" name="direccion_residencia" value="${p.direccion_residencia || ''}">
                </div>
                
                <div class="col-12 text-end mt-3">
                    <button type="submit" class="btn btn-primary">Guardar Cambios</button>
                </div>
            </form>
        </div>
      </div>
    `;
    
    document.getElementById("update-form").addEventListener("submit", async (e) => {
        e.preventDefault();
        const data = Object.fromEntries(new FormData(e.target).entries());
        const alert = document.getElementById("update-alert");
        try {
            // Asumiendo que tienes endpoint PUT implementado
            const res = await fetch(`/api/pacientes/${p.documento_id}`, {
                method: 'PUT', 
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data),
                credentials: 'same-origin'
            });
            if (!res.ok) throw await res.json();
            alert.innerHTML = '<div class="alert alert-success py-2 small">Datos actualizados.</div>';
        } catch (err) {
            alert.innerHTML = `<div class="alert alert-danger py-2 small">Error al actualizar.</div>`;
        }
    });
  }
</script>

<style>
    .nav-tabs .nav-link { color: #64748b; }
    .nav-tabs .nav-link:hover { color: var(--primary-color); }
    .animate-fade-in { animation: fadeIn 0.5s ease-in-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
</style>
{% endblock %}